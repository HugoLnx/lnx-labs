<canvas style="border:2px black solid;" id=graph width=640 height=480></canvas>

<form>
  <div style="float:left;">
    <fieldset id="axesmode">
      <legend>Axes Angle</legend>
      <label for="60-120">60 degrees</label>
      <input type="radio" name="axesmode" id="60-120" checked />
      <label for="120-240">120 degrees</label>
      <input type="radio" name="axesmode" id="120-240"/>
    </fieldset>

    <label for="zoom">Zoom</label>
    <input id="zoom" value="5"/>
    <br/>
    <label for="density">Pixels Per Point (density)</label>
    <input id="density" value="10"/>
  </div>
  <label style="float:left;" for="function">Function</label>
  <br/>
  <textarea id="function" rows=5 cols=30></textarea>
  <br/>
  <button id="desenhar">Draw!</button>
</form>

<script>
  var form = {
    textarea:     document.getElementById("function"),
    button:       document.getElementById("desenhar"),
    zoomInput:    document.getElementById('zoom'),
    densityInput: document.getElementById('density'),
    axes60Radio:  document.getElementById('60-120'),
    axes120Radio:  document.getElementById('120-240')
  }
  form.textarea.value= "function(x,y){\n  return Math.sin(y);\n}";

  var f;
  var perPixel;
  var zoom;
  var axeYAngle;
  var axeXAngle;
  var axes;
  var graphConf;

  form.button.onclick = function(){
    eval("f = " + form.textarea.value);
    zoom = parseInt(form.zoomInput.value);
    perPixel = parseInt(form.densityInput.value);
    if(form.axes120Radio.checked){
      axeYAngle = inRadians(120);
      axeXAngle = inRadians(240);
    } else {
      axeYAngle = inRadians(60);
      axeXAngle = inRadians(120);
    }

    axes = {
      z: {x:0,y:1},
      y: girar(0,1,axeYAngle),
      x: girar(0,1,axeXAngle)
    };
    
    graphConf = {
      z: {x:0,y:zoom},
      y: girar(0,zoom,axeYAngle),
      x: girar(0,zoom,axeXAngle)
    };

    draw();
    return false;
  };

  var canvas = document.getElementById("graph");
  var ctx = canvas.getContext("2d");

  function draw(){
    ctx.clearRect(0,0,640,480);
    drawAxes(axes,300,300,150);

    drawGraphFor(f, 300,300,15,graphConf);
  }

  function drawGraphFor(f,x,y,max,conf){
    for(var ix=0; ix<=max;ix+=1/perPixel){
      for(var iy=0; iy<=max;iy+=1/perPixel){
        var z = f(ix,iy);
        var rz = (y-z*zoom);
        var red = Math.floor(255/2+Math.sin(Math.PI*rz/480-Math.PI/2)*255/2)
        var green = red;
        var blue =  red;
        var color = [red,green,blue];
        drawPointIn(ix,iy,z,x,y,color,conf);
      }
    }
  }

  function drawPointIn(x,y,z,xc,yc,color,conf){
    var p = {x:xc,y:yc};

    var v = conf.z;
    var ax = v.x * z;
    var ay = v.y * z;
    p.x -= ax;
    p.y -= ay;

    v = conf.y;
    ax = v.x * y;
    ay = v.y * y;
    p.x -= ax;
    p.y -= ay;

    v = conf.x;
    ax = v.x * x;
    ay = v.y * x;
    p.x -= ax;
    p.y -= ay;

    ctx.globalAlpha = 0.8;
    ctx.fillStyle = "rgb("+color.join(",")+")";
    ctx.beginPath();
    ctx.arc(p.x,p.y,1,0,Math.PI*2,false);
    ctx.closePath();
    ctx.fill();
  }

  function drawAxes(axes,x,y,size){
    var v = axes.z;
    ctx.beginPath();
    ctx.moveTo(x,y);
    ctx.lineTo(x+v.x*size,y-v.y*size);
    ctx.closePath();
    ctx.stroke();

    v = axes.y;
    ctx.beginPath();
    ctx.moveTo(x,y);
    ctx.lineTo(x-v.x*size,y-v.y*size);
    ctx.closePath();
    ctx.stroke();

    v = axes.x;
    ctx.beginPath();
    ctx.moveTo(x,y);
    ctx.lineTo(x-v.x*size,y-v.y*size);
    ctx.closePath();
    ctx.stroke();
  }

  function inRadians(degree){
    return degree*Math.PI/180;
  }

  function girar(x,y,theta){
      var x2 = Math.cos(theta)*x - Math.sin(theta)*y ;
      var y2 = Math.sin(theta)*x + Math.cos(theta)*y ;
      return {
        x:x2,
        y:y2
      }
  }
</script>
